# 网络是怎样连接的

## 一、浏览器

    浏览器是一个具备多种客户端功能的综合性客户端软件，可以用来在 FTP 服务器上下载和上传文件，同时也具备电子邮件客户端的功能


### 1. 生成 HTTP 请求消息

![URL的各种样式.jpg](/images/网络是怎样连接的/1.1.jpg "URL的各种样式")

浏览器解析 URL

![Web浏览器解析URL的过程.jpg](/images/网络是怎样连接的/1.2.jpg "Web浏览器解析URL的过程")

![路径名为/dir/file1.html的文件.jpg](/images/网络是怎样连接的/1.3.jpg "路径名为/dir/file1.html的文件")

省略文件名的情况

    http://www.lab.glasscom.com/dir/
    以 "/" 结尾代表 /dir/ 后面本来应该有的文件名被省略了，会在服务器上事先设置好文件名省略时要访问的默认文件名

    http://www.lab.glasscom.com/
    表示访问根目录下的默认文件

    http://www.lab.glasscom.com
    没有路径名时代表访问根目录下的默认文件

    http://www.lab.glasscom.com/whatisthis
    由于末尾没有 "/"，如果 Web 服务器上存在名为 whatisthis 的文件，则将 whatisthis 作为文件名来处理；如果存在名为 whatisthis 的目录，则将 whatisthis 作为目录名来处理

浏览器使用 HTTP 协议来访问 Web 服务器

    HTTP 协议定义了客户端和服务器之间交互的消息内容和步骤。
    首先客户端会向服务器发送请求消息。包括“对什么”和“进行怎样的操作”。“对什么”的部分称为URI，这里可以写各种访问目标，而这些目标统称为URI。
    “进行怎样的操作”称为方法。

![HTTP的主要方法.jpg](/images/网络是怎样连接的/b1.1.jpg "HTTP的主要方法")

    收到请求消息后，Web 服务器会对其中的内容进行解析，并根据请求消息中的要求来完成自己的工作，然后将结果存放在响应消息中。
    客户端收到响应消息后，浏览器会从消息中读出所需的数据并显示在屏幕上。

生成 HTTP 请求消息

![HTTP消息的格式.jpg](/images/网络是怎样连接的/1.5.jpg "HTTP消息的格式")

![表单中对方法的区别.jpg](/images/网络是怎样连接的/1.6.jpg "表单中对方法的区别")

HTTP 主要头字段

![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-1.jpg "HTTP主要头字段")
![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-2.jpg "HTTP主要头字段")
![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-3.jpg "HTTP主要头字段")

收到响应

    在响应消息中，第一行的内容为状态码和响应短语，用来表示请求的执行结果是成功还是出错

![HTTP状态码概要.jpg](/images/网络是怎样连接的/b1.3.jpg "HTTP状态码概要")

下列例子为获取名为 sample1.htm 的网页，网页中包含一张名为 picture.jpg 的图片

![HTTP消息示例-1.jpg](/images/网络是怎样连接的/1.7-1.jpg "HTTP消息示例-1")
![HTTP消息示例-2.jpg](/images/网络是怎样连接的/1.7-2.jpg "HTTP消息示例-2")
![HTTP消息示例-3.jpg](/images/网络是怎样连接的/1.7-3.jpg "HTTP消息示例-3")

- - -

### 2. 向 DNS 服务器查询 Web 服务器的 IP 地址

    在委托操作系统发送消息时，必须要提供的不是通信对象的域名，而是它的 IP 地址

IP 地址的基本知识

![IP地址的基本思路.jpg](/images/网络是怎样连接的/1.8.jpg "IP地址的基本思路")

IP 地址中网络号和主机号连起来总共是 32 比特，这两部分具体结构是不固定，需要另外的附加信息来表示 IP 地址的内部结构，这就是子网掩码。

    子网掩码为 1 的部分表示网络号，为 0 表示主机号。
    也可以把 1 的部分的比特数用十进制表示并写在 IP 地址的右侧，如图 1.9(c)所示

![IP地址的表示方法.jpg](/images/网络是怎样连接的/1.9.jpg "IP地址的表示方法")

![IP地址的结构.jpg](/images/网络是怎样连接的/1.10.jpg "IP地址的结构")

人来使用域名，路由器来使用 IP 地址。因此需要一个机制能通过名称查询 IP 地址或通过 IP 地址查询名称，这就是 DNS。

计算机上都有相应的 DNS 客户端，我们称为 DNS 解析器。解析器实际上是一段程序，包含在操作系统的 Socket 库中。

    Socket 库是用于调用网络功能的程序组件集合。

![解析器的调用方法.jpg](/images/网络是怎样连接的/1.11.jpg "解析器的调用方法")

解析器和浏览器一样，本身不具备使用网络收发数据的功能。要使用操作系统中的协议栈发送消息，然后通过网卡将消息发送给 DNS 服务器

    协议栈：操作系统内部的网络控制软件，也叫“协议驱动” “TCP/IP 驱动”等

![调用解析器时计算机内部的工作流程.jpg](/images/网络是怎样连接的/1.12.jpg "调用解析器时计算机内部的工作流程")

向 DNS 服务器发送消息时，我们也需要知道 DNS 服务器的 IP 地址。这个地址作为 TCP/IP 的一个设置项目预先设置好的，下图表示 Windows 系统中的设置

![DNS服务器地址的设置.jpg](/images/网络是怎样连接的/1.13.jpg "DNS服务器地址的设置")

- - -

### 3. 全世界 DNS 服务器的大接力

DNS 服务器，接收来自客户端的查询消息，然后根据消息的内容返回响应，查询消息包含以下 3 种信息

1. 域名

    服务器、邮件服务器（邮件地址中@后面的部分）的名称

2. Class

    在最早设计 DNS 方案时，DNS 在互联网意外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网没有其他的网络了，因此 Class 的值永远是代表互联网 IN

3. 记录类型

    表示域名对应何种类型的记录。例如，当类型为 A(Address) 时，表示域名对应的是 IP 地址；当类型为 MX(Mail eXchange) 时，表示域名对应的是邮件服务器；根据 IP 地址反查域名的 PTR 类型；查询域名相关别名的 CNAME 类型；查询 DNS 服务器 IP 地址的 NS 类型；查询域名属性信息的 SOA 类型


![DNS服务器的基本工作.jpg](/images/网络是怎样连接的/1.14.jpg "DNS服务器的基本工作")

DNS 中的域名都是用句点来分隔的。在域名中，越靠右的位置表示其层级越高，一个域的信息是作为一个整体存放在 DNS 服务器中的，不能将一个域拆开来存放在多台 DNS 服务器中，一台 DNS 服务器中可以存放多个域的信息。

将负责管理下级域的 DNS 服务器的 IP 地址注册到它们的上级 DNS 服务器中，以此类推，就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址

com、jp 这些域（顶级域）上层还有一级域，称为根域，没有名字，一般书写时经常被省略。将根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中，这样任何 DNS 服务器都可以找到并访问根域 DNS 服务器。

![DNS服务器之间的查询操作.jpg](/images/网络是怎样连接的/1.16.jpg "DNS服务器之间的查询操作")

在现实中，一台 DNS 服务器可以管理多个域的信息，上级域和下级域有可能共享同一台 DNS 服务器。

DNS 服务器有缓存的功能，并不需要从最上级的根域开始查找，如果查询的域名信息已经在缓存中，就直接返回响应。并且，要查询的域名不存在时，“不存在”这一响应结果也会被缓存。缓存都有一个有效期

- - -

### 4. 委托协议栈发送消息

![数据通过类似管道的结构来流动.jpg](/images/网络是怎样连接的/1.17.jpg "数据通过类似管道的结构来流动")

以下操作都是由操作系统中的协议栈来执行的

1. 创建套接字

    套接字就是管道两端的数据出入口

2. 将管道连接到服务器端的套接字上

    需要提供描述符、服务器 IP 地址、端口号

        客户端在创建套接字时，协议栈会为这个套接字随便分配一个端口号。接下来，当协议栈执行连接操作时，会将这个随便分配的端口号通知给服务器

3. 收发数据
4. 断开管道并删除套接字

![客户端和服务器之间收发数据操作的情形.jpg](/images/网络是怎样连接的/1.18.jpg "客户端和服务器之间收发数据操作的情形")

- - -