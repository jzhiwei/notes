# 网络是怎样连接的

## 一、浏览器

    浏览器是一个具备多种客户端功能的综合性客户端软件，可以用来在 FTP 服务器上下载和上传文件，同时也具备电子邮件客户端的功能


### 1. 生成 HTTP 请求消息

![URL的各种样式.jpg](/images/网络是怎样连接的/1.1.jpg "URL的各种样式")

浏览器解析 URL

![Web浏览器解析URL的过程.jpg](/images/网络是怎样连接的/1.2.jpg "Web浏览器解析URL的过程")

![路径名为/dir/file1.html的文件.jpg](/images/网络是怎样连接的/1.3.jpg "路径名为/dir/file1.html的文件")

省略文件名的情况

    http://www.lab.glasscom.com/dir/
    以 "/" 结尾代表 /dir/ 后面本来应该有的文件名被省略了，会在服务器上事先设置好文件名省略时要访问的默认文件名

    http://www.lab.glasscom.com/
    表示访问根目录下的默认文件

    http://www.lab.glasscom.com
    没有路径名时代表访问根目录下的默认文件

    http://www.lab.glasscom.com/whatisthis
    由于末尾没有 "/"，如果 Web 服务器上存在名为 whatisthis 的文件，则将 whatisthis 作为文件名来处理；如果存在名为 whatisthis 的目录，则将 whatisthis 作为目录名来处理

浏览器使用 HTTP 协议来访问 Web 服务器

    HTTP 协议定义了客户端和服务器之间交互的消息内容和步骤。
    首先客户端会向服务器发送请求消息。包括“对什么”和“进行怎样的操作”。“对什么”的部分称为URI，这里可以写各种访问目标，而这些目标统称为URI。
    “进行怎样的操作”称为方法。

![HTTP的主要方法.jpg](/images/网络是怎样连接的/b1.1.jpg "HTTP的主要方法")

    收到请求消息后，Web 服务器会对其中的内容进行解析，并根据请求消息中的要求来完成自己的工作，然后将结果存放在响应消息中。
    客户端收到响应消息后，浏览器会从消息中读出所需的数据并显示在屏幕上。

生成 HTTP 请求消息

![HTTP消息的格式.jpg](/images/网络是怎样连接的/1.5.jpg "HTTP消息的格式")

![表单中对方法的区别.jpg](/images/网络是怎样连接的/1.6.jpg "表单中对方法的区别")

HTTP 主要头字段

![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-1.jpg "HTTP主要头字段")
![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-2.jpg "HTTP主要头字段")
![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-3.jpg "HTTP主要头字段")

收到响应

    在响应消息中，第一行的内容为状态码和响应短语，用来表示请求的执行结果是成功还是出错

![HTTP状态码概要.jpg](/images/网络是怎样连接的/b1.3.jpg "HTTP状态码概要")

下列例子为获取名为 sample1.htm 的网页，网页中包含一张名为 picture.jpg 的图片

![HTTP消息示例-1.jpg](/images/网络是怎样连接的/1.7-1.jpg "HTTP消息示例-1")
![HTTP消息示例-2.jpg](/images/网络是怎样连接的/1.7-2.jpg "HTTP消息示例-2")
![HTTP消息示例-3.jpg](/images/网络是怎样连接的/1.7-3.jpg "HTTP消息示例-3")

- - -

### 2. 向 DNS 服务器查询 Web 服务器的 IP 地址

    在委托操作系统发送消息时，必须要提供的不是通信对象的域名，而是它的 IP 地址

IP 地址的基本知识

![IP地址的基本思路.jpg](/images/网络是怎样连接的/1.8.jpg "IP地址的基本思路")

IP 地址中网络号和主机号连起来总共是 32 比特，这两部分具体结构是不固定，需要另外的附加信息来表示 IP 地址的内部结构，这就是子网掩码。

    子网掩码为 1 的部分表示网络号，为 0 表示主机号。
    也可以把 1 的部分的比特数用十进制表示并写在 IP 地址的右侧，如图 1.9(c)所示

![IP地址的表示方法.jpg](/images/网络是怎样连接的/1.9.jpg "IP地址的表示方法")

![IP地址的结构.jpg](/images/网络是怎样连接的/1.10.jpg "IP地址的结构")

人来使用域名，路由器来使用 IP 地址。因此需要一个机制能通过名称查询 IP 地址或通过 IP 地址查询名称，这就是 DNS。

计算机上都有相应的 DNS 客户端，我们称为 DNS 解析器。解析器实际上是一段程序，包含在操作系统的 Socket 库中。

    Socket 库是用于调用网络功能的程序组件集合。

![解析器的调用方法.jpg](/images/网络是怎样连接的/1.11.jpg "解析器的调用方法")

解析器和浏览器一样，本身不具备使用网络收发数据的功能。要使用操作系统中的协议栈发送消息，然后通过网卡将消息发送给 DNS 服务器

    协议栈：操作系统内部的网络控制软件，也叫“协议驱动” “TCP/IP 驱动”等

![调用解析器时计算机内部的工作流程.jpg](/images/网络是怎样连接的/1.12.jpg "调用解析器时计算机内部的工作流程")

向 DNS 服务器发送消息时，我们也需要知道 DNS 服务器的 IP 地址。这个地址作为 TCP/IP 的一个设置项目预先设置好的，下图表示 Windows 系统中的设置

![DNS服务器地址的设置.jpg](/images/网络是怎样连接的/1.13.jpg "DNS服务器地址的设置")

- - -

### 3. 全世界 DNS 服务器的大接力

DNS 服务器，接收来自客户端的查询消息，然后根据消息的内容返回响应，查询消息包含以下 3 种信息

1. 域名

    服务器、邮件服务器（邮件地址中@后面的部分）的名称

2. Class

    在最早设计 DNS 方案时，DNS 在互联网意外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网没有其他的网络了，因此 Class 的值永远是代表互联网 IN

3. 记录类型

    表示域名对应何种类型的记录。例如，当类型为 A(Address) 时，表示域名对应的是 IP 地址；当类型为 MX(Mail eXchange) 时，表示域名对应的是邮件服务器；根据 IP 地址反查域名的 PTR 类型；查询域名相关别名的 CNAME 类型；查询 DNS 服务器 IP 地址的 NS 类型；查询域名属性信息的 SOA 类型


![DNS服务器的基本工作.jpg](/images/网络是怎样连接的/1.14.jpg "DNS服务器的基本工作")

DNS 中的域名都是用句点来分隔的。在域名中，越靠右的位置表示其层级越高，一个域的信息是作为一个整体存放在 DNS 服务器中的，不能将一个域拆开来存放在多台 DNS 服务器中，一台 DNS 服务器中可以存放多个域的信息。

将负责管理下级域的 DNS 服务器的 IP 地址注册到它们的上级 DNS 服务器中，以此类推，就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址

com、jp 这些域（顶级域）上层还有一级域，称为根域，没有名字，一般书写时经常被省略。将根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中，这样任何 DNS 服务器都可以找到并访问根域 DNS 服务器。

![DNS服务器之间的查询操作.jpg](/images/网络是怎样连接的/1.16.jpg "DNS服务器之间的查询操作")

在现实中，一台 DNS 服务器可以管理多个域的信息，上级域和下级域有可能共享同一台 DNS 服务器。

DNS 服务器有缓存的功能，并不需要从最上级的根域开始查找，如果查询的域名信息已经在缓存中，就直接返回响应。并且，要查询的域名不存在时，“不存在”这一响应结果也会被缓存。缓存都有一个有效期

- - -

### 4. 委托协议栈发送消息

![数据通过类似管道的结构来流动.jpg](/images/网络是怎样连接的/1.17.jpg "数据通过类似管道的结构来流动")

以下操作都是由操作系统中的协议栈来执行的

1. 创建套接字

    套接字就是管道两端的数据出入口

2. 将管道连接到服务器端的套接字上

    需要提供描述符、服务器 IP 地址、端口号

        客户端在创建套接字时，协议栈会为这个套接字随便分配一个端口号。接下来，当协议栈执行连接操作时，会将这个随便分配的端口号通知给服务器

3. 收发数据
4. 断开管道并删除套接字

![客户端和服务器之间收发数据操作的情形.jpg](/images/网络是怎样连接的/1.18.jpg "客户端和服务器之间收发数据操作的情形")

- - -

## 二、用电信号传输 TCP/IP 数据

### 1. 创建套接字

![TCP/IP软件采用分册结构.jpg](/images/网络是怎样连接的/2.1.jpg "TCP/IP软件采用分册结构")

    浏览器、邮件等一般应用程序收发数据时用 TCP；
    DNS 查询等收发较短的控制数据时用 UDP

在协议栈的内部有一块用于存放控制信息的内存空间，记录了用于控制通信操作的控制信息，例如通信对象的 IP 地址、端口号、通信操作的进行状态等，我们可以说这些控制信息就是套接字的实体，或者说存放控制信息的内存空间就是套接字的实体

![显示套接字内容.jpg](/images/网络是怎样连接的/2.2.jpg "显示套接字内容")

![收发消息操作.jpg](/images/网络是怎样连接的/2.3.jpg "收发消息操作")

    创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态

### 2. 连接服务器

通信双方建立连接的目的

1. 我们需要把服务器的 IP 地址和端口号等信息告知协议栈
2. 我们需要让客户端向服务器告知必要的信息，如客户端的 IP 地址和端口号，向服务器传达开始通信的请求
3. 分配用于临时存放要收发数据的内存空间，这块空间称为缓冲区

连接实际上是通信双方交换控制信息，一般分为两类

1. 头部中记录的信息
2. 套接字（协议栈中的内存空间）中记录的信息

![TCP头部格式.jpg](/images/网络是怎样连接的/b2.1.jpg "TCP头部格式")

![客户端与服务器之间交换的控制信息.jpg](/images/网络是怎样连接的/2.4.jpg "客户端与服务器之间交换的控制信息")

    客户端 ACK=0 -> 服务器
    服务器 SYN=1 ACK=1 -> 客户端
    客户端 ACK=1 -> 服务器

### 3. 收发数据

应用程序调用 write 时会指定发送数据的长度，协议栈收到数据后会把数据存放在内部的发送缓冲区中，需要再数据积累到一定量时再发送出去，数据量是根据以下几个要素来判断

1. 每个网络包能容纳的数据长度，避免发送大量小包

    MTU(Maximum Transmission Unit,最大传输单元)：一个网络包的最大长度，以太网中一般为 1500 字节
    MSS(Maximum Segment Size, 最大分段大小)：除去头部之后，一个网络包所能容纳的 TCP 数据的最大长度。TCP 和 IP 的头部加起来一般是 40 字节。例如在以太网中， MTU 为 1500，因此 MSS 就是 1460.

    ![MTU和MSS.jpg](/images/网络是怎样连接的/2.5.jpg "MTU和MSS")

2. 等待时间

    协议栈内部会有一个计时器，当经过一定时间之后，就会把缓冲区中的数据发送出去，即使缓冲区中的数据长度没有达到 MSS

在进行发送操作时需要总和考虑这两个要素以达到平衡。应用程序在发送数据时也可以指定一些选项，比如像浏览器这种会话型的应用程序在向服务器发送数据时，等待填满缓冲区导致延迟会产生很大影响，因此一般会使用直接发送的选项


对较大的数据进行拆分

![应用程序数据的拆分发送.jpg](/images/网络是怎样连接的/2.6.jpg "应用程序数据的拆分发送")

    TCP 模块在拆分数据时，会先算好每一块数据相当于从头开始的第几个字节，发送这块数据时，将算好的字节数写在 TCP 头部的“序号”字段。

使用 ACK 号确认网络包已收到

![序号和ACK号的交互.jpg](/images/网络是怎样连接的/2.9.jpg "序号和ACK号的交互")

    TCP 采用这样的方式确认对方是否收到了数据，在得到对方确认之前，发送的包都会保存在发送缓冲区中。如果对方没有返回某些包对应的ACK号，就会重新发送这些包。

ACK号的等待时间（超时时间）

    TCP 会在发送数据的过程中持续测量 ACK 号的返回时间，如果 ACK 号返回变慢，则相应延长等待时间；相对地，如果 ACK 号马山就能返回，则相应缩短等待时间

使用窗口管理 ACK 号

    TCP 采用滑动窗口方式来管理数据发送和 ACK 号的操作。所谓滑动窗口，就是在发送一个包之后，不等待 ACK 号返回，而是直接发送后续的一系列包

![一来一回方式和滑动窗口方式.jpg](/images/网络是怎样连接的/2.10.jpg "一来一回方式和滑动窗口方式")

    避免接收方的接收缓存区溢出，需要接收方告诉发送方自己最多能接收多少数据，这个数据量称为窗口大小（一般和接收方的缓冲区大小一致）

![滑动窗口与接收缓冲区.jpg](/images/网络是怎样连接的/2.11.jpg "滑动窗口与接收缓冲区")

ACK 与窗口的合并

    更新窗口大小的时机应该是接收方从缓冲区中取出数据传递给应用程序，导致接收缓冲区剩余容量增加的时候

    ACK 号应该是接收方收到数据之后向发送方返回 ACK 号

    如果将前面两个因素结合起来看，每收到一个包，就需要向发送方分别发送 ACK 号和窗口更新这两个单独的包。这样一来，接收方发给发送方的包就太多了，导致网络效率下降。
    因此，接收方在发送 ACK 号和窗口更新时，并不会马上把包发送出去，而是会等待一段时间，这样就可以把两种通知合并在一个包里发送了。

接收 HTTP 响应消息

    浏览器在委托协议栈发送请求消息之后，会调用 read 程序来获取响应消息。然后协议栈会执行接下来的操作，响应消息的返回还需要等待一段时间，协议栈会将浏览器的委托暂时挂起，等响应消息到达之后再继续执行接收操作。

### 4. 从服务器断开并删除套接字

断开操作

![断开连接的交互过程.jpg](/images/网络是怎样连接的/2.12.jpg "断开连接的交互过程")

删除套接字

    套接字不会被立即删除，而是会等待一段时间之后再被删除，防止误操作

数据收发操作小结

![TCP的整体流程.jpg](/images/网络是怎样连接的/2.13.jpg "TCP的整体流程")

### 5. IP 与以太网的包收发操作

包的基本知识

    1. 路由器根据目标地址判断下一个路由器的位置
    2. 集线器在子网中将网络包传输到下一个路由

![网络包的基本结构.jpg](/images/网络是怎样连接的/2.14.jpg "网络包的基本结构")

![2.15.jpg](/images/网络是怎样连接的/2.15.jpg "发送方、接收方和转发设备")

![2.16.jpg](/images/网络是怎样连接的/2.16.jpg "IP网络包的传输方式")

包的收发

![2.17.jpg](/images/网络是怎样连接的/2.17.jpg "包收发操作的整体过程")

IP 模块添加如下两个头部

    1. MAC(Media Access Control) 头部：以太网用的头部，包含 MAC 地址
    2. IP 头部：IP 用的头部，包含 IP 地址

![b2.2.jpg](/images/网络是怎样连接的/b2.2.jpg "IP头部格式")

![2.18.jpg](/images/网络是怎样连接的/2.18.jpg "路由表示例")

![b2.3.jpg](/images/网络是怎样连接的/b2.3.jpg "MAC头部的字段")

通过 ARP 查询目标路由器的 MAC 地址

    ARP: Address Resolution Protocol 地址解析协议
    在以太网中，通过广播的方式把包发给连接在同一以太网中的所有设备，以此获得 MAC 地址

![2.19.jpg](/images/网络是怎样连接的/2.19.jpg "用ARP查询MAC地址")

利用 ARP 缓存减少 ARP 包的数量
![2.20.jpg](/images/网络是怎样连接的/2.20.jpg "ARP缓存的内容")
![2.21.jpg](/images/网络是怎样连接的/2.21.jpg "MAC地址")

以太网

    以太网是一种为多态计算机能够彼此自由和廉价地相互通信而设计的通信技术

![2.22.jpg](/images/网络是怎样连接的/2.22.jpg "以太网的基本结构")

网卡

    将数字信息转换成电或光信号
    网卡的 ROM 中保存着全世界唯一的 MAC 地址，这是在生产网卡时写入的。
    网卡中保存的 MAC 地址会由网卡驱动程序读取并分配给 MAC 模块，也可以从命令或者配置文件中读取 MAC 地址分配给 MAC 模块，这时网卡会忽略 ROM 中的 MAC 地址。

![2.23.jpg](/images/网络是怎样连接的/2.23.jpg "网卡")

网卡的工作流程

    网卡驱动从 IP 模块获取包之后，将其复制到网卡内的缓冲区中，然后 MAC 模块将包从缓冲区中取出，并在开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列。
    网卡的 MAC 模块生成通用信号，然后由 PHY（MAU）模块转换成可在网线中传输的格式，并通过网线发送出去。
    MAU: Medium Attachment Unit, 介质连接单元
    PHY: Physical Layer Decive, 物理层装置

![2.24.jpg](/images/网络是怎样连接的/2.24.jpg "网卡发送出去的包")

报头和起始帧分界符

    报头是对信号进行一段时间的观察，找到其变化周期。就是用来测量时钟信号的特殊信号。

    起始帧分界符是一个用来表示包起始位置的标记

    FCS（帧校验序列）用来检查包传输过程中因噪声导致的波形紊乱、数据错误，是一串 32 比特的序列，通过一个公式对包中从头到尾的所有内容进行计算得来的。公式和磁盘等设备中使用的 CRC（Cyclic Redundancy Cheek, 循环冗余校验） 错误校验码是同一种东西。

    将数字信息转换为电信号的速率就是网络的传输速率，例如每秒将 10 Mbit 的数字信息转换为电信号发送出去，则速率就是 10 Mbit/s

![2.25.jpg](/images/网络是怎样连接的/2.25.jpg "报头和起始帧分界符")

![2.26.jpg](/images/网络是怎样连接的/2.26.jpg "通过时钟测量读取信号的时机")

接收包

    接收包时，MAC 模块会检查 MAC 头部中的接收方地址与网卡的 MAC 地址是否一致来判断这个包是不是发给自己的，如果不是自己的包就直接丢弃。但是我们也可以让网卡不检查包的接收方地址，不管是不是自己的包都统统接收下来，这种模式叫“混杂模式（Promiscuous Mode）”。

从 IP 传递给 TCP

    IP 模块检查 IP 头部，如果发生 IP 地址不匹配的错误，IP 模块会通过 ICMP 消息将错误告知发送方

![b2.4.jpg](/images/网络是怎样连接的/b2.4.jpg "主要的ICMP消息")


### 6. UDP 协议

    UDP 没有 TCP 的接收确认、窗口等机制，在收发数据前不需要交换控制信息，也就是不需要建立和断开连接的步骤。遇到错误或丢包一概不管，UDP 只负责单纯地发送包。

    UDP 可发送的数据最大长度为 IP 包的最大长度减去 IP 头部和 UDP 头部的长度。这个长度不同于 MTU、MSS。MTU 和 MSS 是基于以太网和通信线路上网络包的最大长度来计算的，而 IP 包的最大长度是由 IP 头部中的“全长”字段决定的。“全长”字段最大长度为 65535 字节，减去 IP(20字节) 和 UDP(8字节) 头部，那么 UDP 的最大数据长度为 65507 字节，这个数据长度已经超过了以太网和通信线路的最大传输长度，因此需要让 IP 模块使用分片功能进行传输。

![b2.5.jpg](/images/网络是怎样连接的/b2.5.jpg "UDP头部中的控制信息")