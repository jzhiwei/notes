# 网络是怎样连接的

- [浏览器](#一浏览器)
    - [生成HTTP请求消息](#1-生成HTTP请求消息)
    - [向DNS服务器查询Web服务器的IP地址](#2-向DNS服务器查询Web服务器的IP地址)
    - [全世界DNS服务器的大接力](#3-全世界DNS服务器的大接力)
    - [委托协议栈发送消息](#4-委托协议栈发送消息)

- [用电信号传输TCP/IP数据](#二用电信号传输TCP/IP数据)
    - [创建套接字](#1-创建套接字)
    - [连接服务器](#2-连接服务器)
    - [收发数据](#3-收发数据)
    - [从服务器断开并删除套接字](#4-从服务器断开并删除套接字)
    - [IP与以太网的包收发操作](#5-IP与以太网的包收发操作)
    - [UDP协议](#6-UDP协议)

- [从网线到网络设备](#三从网线到网络设备)
    - [信号在网线和集线器中传输](#1-信号在网线和集线器中传输)
    - [交换机的包转发操作](#2-交换机的包转发操作)
    - [路由器的包转发操作](#3-路由器的包转发操作)
    - [路由器的附加功能](#4-路由器的附加功能)

- [通过接入网进入互联网内部](#四通过接入网进入互联网内部)
    - [ADSL接入网的结构和工作方式](#1-ADSL接入网的结构和工作方式)
    - [光纤接入网FTTH](#2-光纤接入网FTTH)
    - [接入网中使用的PPP和隧道](#3-接入网中使用的PPP和隧道)
    - [网络运营商的内部](#4-网络运营商的内部)
    - [跨越运营商的网络包](#5-跨越运营商的网络包)

- [服务器端的局域网](#五服务器端的局域网)
    - [Web服务器的部署地点](#1-Web服务器的部署地点)
    - [防火墙的结构和原理](#2-防火墙的结构和原理)
    - [服务器的负载均衡](#3-服务器的负载均衡)
    - [缓存服务器](#4-缓存服务器)
    - [内容分发服务](#5-内容分发服务)

- [Web服务器返回响应到浏览器](#六Web服务器返回响应到浏览器)
    - [服务器概览](#1-服务器概览)
    - [服务器的接收操作](#2-服务器的接收操作)
    - [Web服务器程序作出响应](#3-Web服务器程序作出响应)
    - [浏览器接收响应消息并显示内容](#4-浏览器接收响应消息并显示内容)

- [网络包的旅程](#网络包的旅程)



## 一、浏览器

    浏览器是一个具备多种客户端功能的综合性客户端软件，可以用来在 FTP 服务器上下载和上传文件，同时也具备电子邮件客户端的功能


### 1. 生成HTTP请求消息

![URL的各种样式.jpg](/images/网络是怎样连接的/1.1.jpg "URL的各种样式")

浏览器解析 URL

![Web浏览器解析URL的过程.jpg](/images/网络是怎样连接的/1.2.jpg "Web浏览器解析URL的过程")

![路径名为/dir/file1.html的文件.jpg](/images/网络是怎样连接的/1.3.jpg "路径名为/dir/file1.html的文件")

省略文件名的情况

    http://www.lab.glasscom.com/dir/
    以 "/" 结尾代表 /dir/ 后面本来应该有的文件名被省略了，会在服务器上事先设置好文件名省略时要访问的默认文件名

    http://www.lab.glasscom.com/
    表示访问根目录下的默认文件

    http://www.lab.glasscom.com
    没有路径名时代表访问根目录下的默认文件

    http://www.lab.glasscom.com/whatisthis
    由于末尾没有 "/"，如果 Web 服务器上存在名为 whatisthis 的文件，则将 whatisthis 作为文件名来处理；如果存在名为 whatisthis 的目录，则将 whatisthis 作为目录名来处理

浏览器使用 HTTP 协议来访问 Web 服务器

    HTTP 协议定义了客户端和服务器之间交互的消息内容和步骤。
    首先客户端会向服务器发送请求消息。包括“对什么”和“进行怎样的操作”。“对什么”的部分称为URI，这里可以写各种访问目标，而这些目标统称为URI。
    “进行怎样的操作”称为方法。

![HTTP的主要方法.jpg](/images/网络是怎样连接的/b1.1.jpg "HTTP的主要方法")

    收到请求消息后，Web 服务器会对其中的内容进行解析，并根据请求消息中的要求来完成自己的工作，然后将结果存放在响应消息中。
    客户端收到响应消息后，浏览器会从消息中读出所需的数据并显示在屏幕上。

生成 HTTP 请求消息

![HTTP消息的格式.jpg](/images/网络是怎样连接的/1.5.jpg "HTTP消息的格式")

![表单中对方法的区别.jpg](/images/网络是怎样连接的/1.6.jpg "表单中对方法的区别")

HTTP 主要头字段

![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-1.jpg "HTTP主要头字段")
![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-2.jpg "HTTP主要头字段")
![HTTP主要头字段.jpg](/images/网络是怎样连接的/b1.2-3.jpg "HTTP主要头字段")

收到响应

    在响应消息中，第一行的内容为状态码和响应短语，用来表示请求的执行结果是成功还是出错

![HTTP状态码概要.jpg](/images/网络是怎样连接的/b1.3.jpg "HTTP状态码概要")

下列例子为获取名为 sample1.htm 的网页，网页中包含一张名为 picture.jpg 的图片

![HTTP消息示例-1.jpg](/images/网络是怎样连接的/1.7-1.jpg "HTTP消息示例-1")
![HTTP消息示例-2.jpg](/images/网络是怎样连接的/1.7-2.jpg "HTTP消息示例-2")
![HTTP消息示例-3.jpg](/images/网络是怎样连接的/1.7-3.jpg "HTTP消息示例-3")

### 2. 向DNS服务器查询Web服务器的IP地址

    在委托操作系统发送消息时，必须要提供的不是通信对象的域名，而是它的 IP 地址

IP 地址的基本知识

![IP地址的基本思路.jpg](/images/网络是怎样连接的/1.8.jpg "IP地址的基本思路")

IP 地址中网络号和主机号连起来总共是 32 比特，这两部分具体结构是不固定，需要另外的附加信息来表示 IP 地址的内部结构，这就是子网掩码。

    子网掩码为 1 的部分表示网络号，为 0 表示主机号。
    也可以把 1 的部分的比特数用十进制表示并写在 IP 地址的右侧，如图 1.9(c)所示

![IP地址的表示方法.jpg](/images/网络是怎样连接的/1.9.jpg "IP地址的表示方法")

![IP地址的结构.jpg](/images/网络是怎样连接的/1.10.jpg "IP地址的结构")

人来使用域名，路由器来使用 IP 地址。因此需要一个机制能通过名称查询 IP 地址或通过 IP 地址查询名称，这就是 DNS。

计算机上都有相应的 DNS 客户端，我们称为 DNS 解析器。解析器实际上是一段程序，包含在操作系统的 Socket 库中。

    Socket 库是用于调用网络功能的程序组件集合。

![解析器的调用方法.jpg](/images/网络是怎样连接的/1.11.jpg "解析器的调用方法")

解析器和浏览器一样，本身不具备使用网络收发数据的功能。要使用操作系统中的协议栈发送消息，然后通过网卡将消息发送给 DNS 服务器

    协议栈：操作系统内部的网络控制软件，也叫“协议驱动” “TCP/IP 驱动”等

![调用解析器时计算机内部的工作流程.jpg](/images/网络是怎样连接的/1.12.jpg "调用解析器时计算机内部的工作流程")

向 DNS 服务器发送消息时，我们也需要知道 DNS 服务器的 IP 地址。这个地址作为 TCP/IP 的一个设置项目预先设置好的，下图表示 Windows 系统中的设置

![DNS服务器地址的设置.jpg](/images/网络是怎样连接的/1.13.jpg "DNS服务器地址的设置")

### 3. 全世界DNS服务器的大接力

DNS 服务器，接收来自客户端的查询消息，然后根据消息的内容返回响应，查询消息包含以下 3 种信息

1. 域名

    服务器、邮件服务器（邮件地址中@后面的部分）的名称

2. Class

    在最早设计 DNS 方案时，DNS 在互联网以外的其他网络中的应用也被考虑到了，而 Class 就是用来识别网络的信息。不过，如今除了互联网没有其他的网络了，因此 Class 的值永远是代表互联网 IN

3. 记录类型

    表示域名对应何种类型的记录。例如，当类型为 A(Address) 时，表示域名对应的是 IP 地址；当类型为 MX(Mail eXchange) 时，表示域名对应的是邮件服务器；根据 IP 地址反查域名的 PTR 类型；查询域名相关别名的 CNAME 类型；查询 DNS 服务器 IP 地址的 NS 类型；查询域名属性信息的 SOA 类型


![DNS服务器的基本工作.jpg](/images/网络是怎样连接的/1.14.jpg "DNS服务器的基本工作")

DNS 中的域名都是用句点来分隔的。在域名中，越靠右的位置表示其层级越高，一个域的信息是作为一个整体存放在 DNS 服务器中的，不能将一个域拆开来存放在多台 DNS 服务器中，一台 DNS 服务器中可以存放多个域的信息。

将负责管理下级域的 DNS 服务器的 IP 地址注册到它们的上级 DNS 服务器中，以此类推，就可以通过上级 DNS 服务器查询出下级 DNS 服务器的 IP 地址

com、jp 这些域（顶级域）上层还有一级域，称为根域，没有名字，一般书写时经常被省略。将根域的 DNS 服务器信息保存在互联网中所有的 DNS 服务器中，这样任何 DNS 服务器都可以找到并访问根域 DNS 服务器。

![DNS服务器之间的查询操作.jpg](/images/网络是怎样连接的/1.16.jpg "DNS服务器之间的查询操作")

在现实中，一台 DNS 服务器可以管理多个域的信息，上级域和下级域有可能共享同一台 DNS 服务器。

DNS 服务器有缓存的功能，并不需要从最上级的根域开始查找，如果查询的域名信息已经在缓存中，就直接返回响应。并且，要查询的域名不存在时，“不存在”这一响应结果也会被缓存。缓存都有一个有效期

### 4. 委托协议栈发送消息

![数据通过类似管道的结构来流动.jpg](/images/网络是怎样连接的/1.17.jpg "数据通过类似管道的结构来流动")

以下操作都是由操作系统中的协议栈来执行的

1. 创建套接字

    套接字就是管道两端的数据出入口

2. 将管道连接到服务器端的套接字上

    需要提供描述符、服务器 IP 地址、端口号

        客户端在创建套接字时，协议栈会为这个套接字随便分配一个端口号。接下来，当协议栈执行连接操作时，会将这个随便分配的端口号通知给服务器

3. 收发数据
4. 断开管道并删除套接字

![客户端和服务器之间收发数据操作的情形.jpg](/images/网络是怎样连接的/1.18.jpg "客户端和服务器之间收发数据操作的情形")

- - -

## 二、用电信号传输TCP/IP数据

### 1. 创建套接字

![TCP/IP软件采用分册结构.jpg](/images/网络是怎样连接的/2.1.jpg "TCP/IP软件采用分册结构")

    浏览器、邮件等一般应用程序收发数据时用 TCP；
    DNS 查询等收发较短的控制数据时用 UDP

在协议栈的内部有一块用于存放控制信息的内存空间，记录了用于控制通信操作的控制信息，例如通信对象的 IP 地址、端口号、通信操作的进行状态等，我们可以说这些控制信息就是套接字的实体，或者说存放控制信息的内存空间就是套接字的实体

![显示套接字内容.jpg](/images/网络是怎样连接的/2.2.jpg "显示套接字内容")

![收发消息操作.jpg](/images/网络是怎样连接的/2.3.jpg "收发消息操作")

    创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态

### 2. 连接服务器

通信双方建立连接的目的

1. 我们需要把服务器的 IP 地址和端口号等信息告知协议栈
2. 我们需要让客户端向服务器告知必要的信息，如客户端的 IP 地址和端口号，向服务器传达开始通信的请求
3. 分配用于临时存放要收发数据的内存空间，这块空间称为缓冲区

连接实际上是通信双方交换控制信息，一般分为两类

1. 头部中记录的信息
2. 套接字（协议栈中的内存空间）中记录的信息

![TCP头部格式.jpg](/images/网络是怎样连接的/b2.1.jpg "TCP头部格式")

![客户端与服务器之间交换的控制信息.jpg](/images/网络是怎样连接的/2.4.jpg "客户端与服务器之间交换的控制信息")

### 3. 收发数据

应用程序调用 write 时会指定发送数据的长度，协议栈收到数据后会把数据存放在内部的发送缓冲区中，需要在数据积累到一定量时再发送出去，数据量是根据以下几个要素来判断

1. 每个网络包能容纳的数据长度，避免发送大量小包

        MTU(Maximum Transmission Unit,最大传输单元)：一个网络包的最大长度，以太网中一般为 1500 字节
        MSS(Maximum Segment Size, 最大分段大小)：除去头部之后，一个网络包所能容纳的 TCP 数据的最大长度。TCP 和 IP 的头部加起来一般是 40 字节。例如在以太网中， MTU 为 1500，因此 MSS 就是 1460.

    ![MTU和MSS.jpg](/images/网络是怎样连接的/2.5.jpg "MTU和MSS")

2. 等待时间

    协议栈内部会有一个计时器，当经过一定时间之后，就会把缓冲区中的数据发送出去，即使缓冲区中的数据长度没有达到 MSS

在进行发送操作时需要综合考虑这两个要素以达到平衡。应用程序在发送数据时也可以指定一些选项，比如像浏览器这种会话型的应用程序在向服务器发送数据时，等待填满缓冲区导致延迟会产生很大影响，因此一般会使用直接发送的选项


对较大的数据进行拆分

![应用程序数据的拆分发送.jpg](/images/网络是怎样连接的/2.6.jpg "应用程序数据的拆分发送")

    TCP 模块在拆分数据时，会先算好每一块数据相当于从头开始的第几个字节，发送这块数据时，将算好的字节数写在 TCP 头部的“序号”字段。

使用 ACK 号确认网络包已收到

![序号和ACK号的交互.jpg](/images/网络是怎样连接的/2.9.jpg "序号和ACK号的交互")

    TCP 采用这样的方式确认对方是否收到了数据，在得到对方确认之前，发送的包都会保存在发送缓冲区中。如果对方没有返回某些包对应的ACK号，就会重新发送这些包。

ACK号的等待时间（超时时间）

    TCP 会在发送数据的过程中持续测量 ACK 号的返回时间，如果 ACK 号返回变慢，则相应延长等待时间；相对地，如果 ACK 号马上就能返回，则相应缩短等待时间

使用窗口管理 ACK 号

    TCP 采用滑动窗口方式来管理数据发送和 ACK 号的操作。所谓滑动窗口，就是在发送一个包之后，不等待 ACK 号返回，而是直接发送后续的一系列包

![一来一回方式和滑动窗口方式.jpg](/images/网络是怎样连接的/2.10.jpg "一来一回方式和滑动窗口方式")

    避免接收方的接收缓存区溢出，需要接收方告诉发送方自己最多能接收多少数据，这个数据量称为窗口大小（一般和接收方的缓冲区大小一致）

![滑动窗口与接收缓冲区.jpg](/images/网络是怎样连接的/2.11.jpg "滑动窗口与接收缓冲区")

ACK 与窗口的合并

    更新窗口大小的时机应该是接收方从缓冲区中取出数据传递给应用程序，导致接收缓冲区剩余容量增加的时候

    ACK 号应该是接收方收到数据之后向发送方返回 ACK 号

    如果将前面两个因素结合起来看，每收到一个包，就需要向发送方分别发送 ACK 号和窗口更新这两个单独的包。这样一来，接收方发给发送方的包就太多了，导致网络效率下降。
    因此，接收方在发送 ACK 号和窗口更新时，并不会马上把包发送出去，而是会等待一段时间，这样就可以把两种通知合并在一个包里发送了。

接收 HTTP 响应消息

    浏览器在委托协议栈发送请求消息之后，会调用 read 程序来获取响应消息。然后协议栈会执行接下来的操作，响应消息的返回还需要等待一段时间，协议栈会将浏览器的委托暂时挂起，等响应消息到达之后再继续执行接收操作。

### 4. 从服务器断开并删除套接字

断开操作

![断开连接的交互过程.jpg](/images/网络是怎样连接的/2.12.jpg "断开连接的交互过程")

删除套接字

    套接字不会被立即删除，而是会等待一段时间之后再被删除，防止误操作

数据收发操作小结

![TCP的整体流程.jpg](/images/网络是怎样连接的/2.13.jpg "TCP的整体流程")

### 5. IP与以太网的包收发操作

包的基本知识

    1. 路由器根据目标地址判断下一个路由器的位置
    2. 集线器在子网中将网络包传输到下一个路由

![网络包的基本结构.jpg](/images/网络是怎样连接的/2.14.jpg "网络包的基本结构")

![发送方、接收方和转发设备.jpg](/images/网络是怎样连接的/2.15.jpg "发送方、接收方和转发设备")

![IP网络包的传输方式.jpg](/images/网络是怎样连接的/2.16.jpg "IP网络包的传输方式")

包的收发

![包收发操作的整体过程.jpg](/images/网络是怎样连接的/2.17.jpg "包收发操作的整体过程")

IP 模块添加如下两个头部

    1. MAC(Media Access Control) 头部：以太网用的头部，包含 MAC 地址
    2. IP 头部：IP 用的头部，包含 IP 地址

![IP头部格式.jpg](/images/网络是怎样连接的/b2.2.jpg "IP头部格式")

![路由表示例.jpg](/images/网络是怎样连接的/2.18.jpg "路由表示例")

![MAC头部的字段.jpg](/images/网络是怎样连接的/b2.3.jpg "MAC头部的字段")

通过 ARP 查询目标路由器的 MAC 地址

    ARP: Address Resolution Protocol 地址解析协议
    在以太网中，通过广播的方式把包发给连接在同一以太网中的所有设备，以此获得 MAC 地址

![用ARP查询MAC地址.jpg](/images/网络是怎样连接的/2.19.jpg "用ARP查询MAC地址")

利用 ARP 缓存减少 ARP 包的数量
![ARP缓存的内容.jpg](/images/网络是怎样连接的/2.20.jpg "ARP缓存的内容")
![MAC地址.jpg](/images/网络是怎样连接的/2.21.jpg "MAC地址")

以太网

    以太网是一种为多台计算机能够彼此自由和廉价地相互通信而设计的通信技术

![以太网的基本结构.jpg](/images/网络是怎样连接的/2.22.jpg "以太网的基本结构")

网卡

    将数字信息转换成电或光信号
    网卡的 ROM 中保存着全世界唯一的 MAC 地址，这是在生产网卡时写入的。
    网卡中保存的 MAC 地址会由网卡驱动程序读取并分配给 MAC 模块，也可以从命令或者配置文件中读取 MAC 地址分配给 MAC 模块，这时网卡会忽略 ROM 中的 MAC 地址。

![网卡.jpg](/images/网络是怎样连接的/2.23.jpg "网卡")

网卡的工作流程

    网卡驱动从 IP 模块获取包之后，将其复制到网卡内的缓冲区中，然后 MAC 模块将包从缓冲区中取出，并在开头加上报头和起始帧分界符，在末尾加上用于检测错误的帧校验序列。
    网卡的 MAC 模块生成通用信号，然后由 PHY（MAU）模块转换成可在网线中传输的格式，并通过网线发送出去。
    MAU: Medium Attachment Unit, 介质连接单元
    PHY: Physical Layer Decive, 物理层装置

![网卡发送出去的包.jpg](/images/网络是怎样连接的/2.24.jpg "网卡发送出去的包")

报头和起始帧分界符

    报头是对信号进行一段时间的观察，找到其变化周期。就是用来测量时钟信号的特殊信号。

    起始帧分界符是一个用来表示包起始位置的标记

    FCS（帧校验序列）用来检查包传输过程中因噪声导致的波形紊乱、数据错误，是一串 32 比特的序列，通过一个公式对包中从头到尾的所有内容进行计算得来的。公式和磁盘等设备中使用的 CRC（Cyclic Redundancy Cheek, 循环冗余校验） 错误校验码是同一种东西。

    将数字信息转换为电信号的速率就是网络的传输速率，例如每秒将 10 Mbit 的数字信息转换为电信号发送出去，则速率就是 10 Mbit/s

![报头和起始帧分界符.jpg](/images/网络是怎样连接的/2.25.jpg "报头和起始帧分界符")

![通过时钟测量读取信号的时机.jpg](/images/网络是怎样连接的/2.26.jpg "通过时钟测量读取信号的时机")

接收包

    接收包时，MAC 模块会检查 MAC 头部中的接收方地址与网卡的 MAC 地址是否一致来判断这个包是不是发给自己的，如果不是自己的包就直接丢弃。但是我们也可以让网卡不检查包的接收方地址，不管是不是自己的包都统统接收下来，这种模式叫“混杂模式（Promiscuous Mode）”。

将服务器的响应包从 IP 传递给 TCP

    IP 模块检查 IP 头部，如果发生 IP 地址不匹配的错误，IP 模块会通过 ICMP 消息将错误告知发送方

![主要的ICMP消息.jpg](/images/网络是怎样连接的/b2.4.jpg "主要的ICMP消息")


### 6. UDP协议

    UDP 没有 TCP 的接收确认、窗口等机制，在收发数据前不需要交换控制信息，也就是不需要建立和断开连接的步骤。遇到错误或丢包一概不管，UDP 只负责单纯地发送包。

    UDP 可发送的数据最大长度为 IP 包的最大长度减去 IP 头部和 UDP 头部的长度。这个长度不同于 MTU、MSS。MTU 和 MSS 是基于以太网和通信线路上网络包的最大长度来计算的，而 IP 包的最大长度是由 IP 头部中的“全长”字段决定的。“全长”字段最大长度为 65535 字节，减去 IP(20字节) 和 UDP(8字节) 头部，那么 UDP 的最大数据长度为 65507 字节，这个数据长度已经超过了以太网和通信线路的最大传输长度，因此需要让 IP 模块使用分片功能进行传输。

![UDP头部中的控制信息.jpg](/images/网络是怎样连接的/b2.5.jpg "UDP头部中的控制信息")

- - -

## 三、从网线到网络设备

### 1. 信号在网线和集线器中传输

![网卡与集线器用双绞线连接的形态.jpg](/images/网络是怎样连接的/3.2.jpg "网卡与集线器用双绞线连接的形态")

信号衰减

    信号在网线的传输过程中，能量会逐渐损失。网线越长，信号衰减就越严重。即便线路条件很好，没有噪声，信号在传输过程中依然会发生失真，如果再加上噪声的影响，失真就会更厉害。如果本来就已经衰减的信号再进一步失真，就会出现对 0 和 1 的误判，这就是产生通信错误的原因。

![接收方信号变得难以识别.jpg](/images/网络是怎样连接的/3.3.jpg "接收方信号变得难以识别")

噪声

    产生噪声的原因是网线周围的电磁波，当电磁波接触到金属等导体时，在其中就会产生电流。如果网线周围存在电磁波，就会在网线中产生和原本的信号不同的电流。由于信号本身也是一种带有电压变化的电流，本质和噪声产生的电流是一样的，所以信号和噪声的电流就会混杂在一起，导致信号的波形发生失真，这就是噪声的影响。
    影响网线的电磁波分为两种。一种是由电机、荧光灯、CRT 显示器等设备泄漏出来的电磁波。当电磁波接触到信号线（金属做的）时，会沿着磁波传播的右旋方向产生电流，这种电流会导致波形发生失真。如果我们将信号线缠绕在一起，信号线就变成了螺旋形，其中两根信号线中产生的噪声电流方向就会相反，从而使得噪声电流相互抵消，噪声就得到了抑制。
    另一种电磁波是从网线中相邻的信号线泄漏出来的。由于传输的信号本身就是一种电流，当电流流过时就会向周围发出电磁波，这些电磁波对于其他信号线来说就变成了噪声。这种内部产生的噪声称为串扰。

![双绞线对噪声的抑制.jpg](/images/网络是怎样连接的/3.4.jpg "双绞线对噪声的抑制")

![双绞线的种类.jpg](/images/网络是怎样连接的/b3.1.jpg "双绞线的种类")

集线器

    当信号到达集线器后，会被广播到整个网络中。以太网的基本架构就是将包发到所有的设备，然后由设备根据接收方 MAC 地址来判断应该接收哪些包。
    信号到达集线器的 PHY（MAU）模块后，会进入中继电路。中继电路的基本功能就是将输入的信号原封不动的广播到集线器的所有端口上。
    接下来，信号从所有接口流出，到达连接在集线器上的所有设备。然后这些设备会通过 MAC 头部中接收方的 MAC 地址判断是不是发给自己的，否则就忽略。

![交叉网线的使用.jpg](/images/网络是怎样连接的/3.5.jpg "交叉网线的使用")

![交叉网线.jpg](/images/网络是怎样连接的/3.6.jpg "交叉网线")

### 2. 交换机的包转发操作

根据地址表进行转发

    交换机的设计是将网络包原样转发到目的地。信号到达网线接口，并由 PHY（MAU）模块接收，这部分与集线器是相同的。接下来，PHY 模块会将网线中的信号转换为通用格式，然后传递给 MAC 模块。MAC 模块将信号转换为数字信息，然后 FCS 校验通过后放到缓冲区中。这部分和网卡基本相同，大家可以认为交换机的每个网线接口后面都是一块网卡。网线接口和后面的电路部分加在一起称为一个端口，也就是说交换机的一个端口就相当于计算机上的一块网卡。但是端口不具有 MAC 地址，因此不核对接收方 MAC 地址，而是直接接收所有的包并存放到缓冲区中。
    将包存入缓冲区后，查询这个包的接收方 MAC 地址是否在 MAC 地址表中。MAC 地址表主要包含设备的 MAC 地址和该设备连接在交换机上的端口号。只要某个设备发送过网络包，它的 MAC 地址就会被记录到地址表中。
    当网络包通过交换电路到达发送端口时，端口中的 MAC 模块和 PHY 模块会执行发送操作，将信号发送到网线中，这部分和网卡发送信号的过程是一样的。

![交换机的结构.jpg](/images/网络是怎样连接的/3.7.jpg "交换机的结构")

![交换电路的设计.jpg](/images/网络是怎样连接的/3.8.jpg "交换电路的设计")

特殊操作

    当交换机发现一个包要发回到源端口时，就会直接丢弃这个包。

    当在地址表中找不到指定的 MAC 地址，交换机无法判断应该把包转发到哪个端口，只能将包转发到除了源端口之外的所有端口。

自动协商

    相互连接的双方探测对方是否支持全双工模式，并自动切换成相应的工作模式，还能探测对方的传输速率并进行自动切换。
    在以太网中，当没有数据在传输时，网络中会填充一种被称为连接脉冲的脉冲信号。以太网设备的网线接口周围有一个绿色的 LED 指示灯，它表示是否检测到正常的脉冲信号，如果绿灯亮，说明 PHY 模块以及网线连接正常。自动协商功能就利用了具有特定排列的脉冲信号，将自己能够支持的工作模式和传输速率告知对方。

### 3. 路由器的包转发操作

路由器的基本结构

    路由器包括转发模块和端口模块，其中转发模块负责判断包的转发目的地，端口模块负责包的收发操作。转发模块相当于协议栈的 IP 模块，端口模块相当于网卡。
    端口模块是以实际的发送方或者接收方的身份来收发网络包的。以以太网端口为例，路由器的端口具有 MAC 地址，因此它就能够成为以太网的发送方和接收方（但不会成为 IP 的接收方和发送方）。端口还具有 IP 地址，这和计算机的网卡是一样的。

![路由器的结构.jpg](/images/网络是怎样连接的/3.12.jpg "路由器的结构")

路由表

    路由器会忽略主机号，只匹配网络号。主机号部分比特全部为 0 表示一个子网，主机号部分比特不全部为 0 表示某一台计算机。匹配到某条记录后，路由器就会将网络包交给接口列中指定的网络接口，并转发到网关列中指定的 IP 地址。跃点计数表示距离目标 IP 地址的距离。数字越小，目的地越近。
    
在转发包的过程中不需要对路由表的内容进行维护。对路由表进行维护大体分为两类

    1. 由人手动维护路由记录
    2. 根据路由协议（RIP、OSPC、BGP 等）机制，通过路由器之间的信息交换由路由器自行维护路由表的记录

![路由器根据路由表对包进行转发.jpg](/images/网络是怎样连接的/3.13.jpg "路由器根据路由表对包进行转发")

路由器的包接收操作

    路由器端口都具有 MAC 地址，只接收与自身地址匹配的包，遇到不匹配的包则直接丢弃。

    通过路由器转发的网络包，其接收方 MAC 地址为路由器端口的 MAC 地址。当包到达路由器之后，MAC 头部就会被丢弃。

    接下来路由器会根据 IP 头部中的内容进行包转发，首先查询路由表判断转发目标，根据“最长匹配原则”进行匹配。

    路由表中子网掩码为 0.0.0.0 的记录表示“默认路由”，当匹配不到其他路由时，网络包就会被转发到互联网接入路由器，这一行配置的网关称为默认网关。

包的有效期

    接下来是更新 IP 头部中的 TTL（Time to Live，生存时间）字段。表示包的有效期，包每经过一个路由器的转发，这个值就会减 1， 当这个值变成 0 时，就表示超过了有效期，这个包就会被丢弃。

分片

    如果输出端口的最大包长度小于输入端口，就无法直接发送这个包了，就要使用 IP 协议中的分片功能对包进行拆分。这与 TCP 的拆分机制不同，TCP 是在将数据装到包里之前进行的。而 IP 分片是对一个整包进行拆分。

![对包进行拆分的分片功能.jpg](/images/网络是怎样连接的/3.15.jpg "对包进行拆分的分片功能")

路由器的发送操作

    如果路由表的网关列内容为 IP 地址，则该地址就是下一个转发目标；如果路由表的网关列内容为空，则 IP 头部中的接收方 IP 地址就是下一个转发目标。

    路由器也会使用 ARP 来查询下一个转发目标的 MAC 地址

路由器与交换机的关系

    IP（路由器）负责将包送达通信对象这一整体过程，而其中将包传输到下一个路由器的过程则是由以太网（交换机）来负责的。

### 4. 路由器的附加功能

地址转换

    地址转换的基本原理是在转发网络包时对 IP 头部中的 IP 地址和端口号进行改写。

私有地址的范围

    10.0.0.0 ~ 10.255.255.255
    172.16.0.0 ~ 172.31.255.255
    192.168.0.0 ~ 192.168.255.255

![私有地址和公有地址分别管理.jpg](/images/网络是怎样连接的/3.17.jpg "私有地址和公有地址分别管理")

![利用端口号改写IP地址.jpg](/images/网络是怎样连接的/3.18.jpg "利用端口号改写IP地址")

![从互联网访问公司内网.jpg](/images/网络是怎样连接的/3.19.jpg "从互联网访问公司内网")

包过滤

    就是在对包进行转发时，按照事先设置好的规则决定是转发这个包，还是丢弃这个包。可以利用这一机制防止非法入侵。

- - -

## 四、通过接入网进入互联网内部

### 1. ADSL接入网的结构和工作方式

![互联网的整体架构.jpg](/images/网络是怎样连接的/4.1.jpg "互联网的整体架构")

距离的不同和路由的维护方式就是互联网与家庭、公司网络之间最主要的两个不同点。

连接用户与互联网的接入网

    接入网就是指连接互联网与家庭、公司网络的通信线路。一般家用的接入方式包括 ADSL、FTTH、CATV、电话线、ISDN 等
    ADSL: Asymmetric Digital Subscriber Line, 不对称数字用户线。是一种利用架设在电线杆上的金属电话线来进行高速通信的技术，它的上行方向（用户到互联网）和下行方向（互联网到用户）的通信速率是不对称的。
    FTTH: Fiber To The Home, 光纤到户。

ADSL

![ADSL接入网的结构（PPPoE方式）.jpg](/images/网络是怎样连接的/4.2.jpg "ADSL接入网的结构（PPPoE方式）")

![不断改变形态的网络包.jpg](/images/网络是怎样连接的/4.3.jpg "不断改变形态的网络包")

    BAS: Broadband Access Server, 宽带接入服务器。它也是一种路由器。
    PPP: Point-to-Point Protocol, 点到点协议。它是电话线、ISDN 等通信线路所使用的一种协议，集成了用户认证、配置下发、数据压缩、加密等各种功能。

    互联网接入路由器会在网络包前面加上 MAC 头部、PPPoE 头部、PPP 头部 3 种头部，然后发送给 ADSL Modem（PPPoE方式下）。

    ATM: Asynchronous Transfer Mode, 异步传输。数据传输是以“信元”为单位来进行的，这种方式不适用与计算机通信。

    ADSL Modem 将包拆分成信元，并转换成电信号发送给分离器。

分离器

    分离器可以过滤掉高频信号，防止 ADSL 对电话产生干扰。同时也可以防止电话对 ADSL 产生干扰，因为电话的听筒拿起来后会导致线路状态改变，如果 ADSL 通信过程中线路状态改变，就需要重新握手，这会导致几十秒的通信中断，分离器可以防止发生这样的问题。

噪声

    电话线受到干扰的方式和双绞线不同。双绞线中只有一路方波信号，信号失真后就无法读取还原成数字信号，于是就会产生错误。ADSL 信号分布在多个频段上，只有和噪声频率相同的信号会受到影响而无法读取，即可用的信号数量减少，结果导致速率下降。

DSLAM

    DSLAM: DSL Access Multiplexer, 数字用户线接入复用设备。是一种电话局用的多路 ADSL Modem，可以理解为将多个 ADSL Modem 整合在一个外壳里的设备。

BAS

    是一种包转发设备，具有 ATM 接口，将 ATM 信元还原成原始的包，然后将包前面的 MAC 头部和 PPPoE 头部丢弃（MAC 头部和 PPPoE 头部的作用是将包送达 BAS 接口），取出 PPP 头部以及后面的数据，然后再包的前面加上隧道专用头部（一般是 L2TP 头部），发送到隧道的出口。

### 2. 光纤接入网FTTH

![光纤的结构.jpg](/images/网络是怎样连接的/4.9.jpg "光纤的结构")

![光通信的原理.jpg](/images/网络是怎样连接的/4.10.jpg "光通信的原理")

光纤分路

![FTTH接入网的结构.jpg](/images/网络是怎样连接的/4.16.jpg "FTTH接入网的结构")

### 3. 接入网中使用的PPP和隧道

PPP

    PPP 协议没有定义以太网中的报头和 FCS 等元素，也没有定义信号的格式，因此无法直接将 PPP 消息转换成信号来发送。要传输 PPP 消息，必有有另一个包含报头、FCS、信号格式等元素的“容器”，于是在拨号接入中 PPP 借用了 HDLC 协议作为容器。
    HDLC: High-level Data Link Control, 高级数据联接控制，是为在专线中传输网络包而设计的。

![PPP拨号连接操作.jpg](/images/网络是怎样连接的/4.17.jpg "PPP拨号连接操作")

PPPoE

    用以太网包代替 HDLC 来装载 PPP 协议，为了弥补以太网和 PPP 在设计上的不同，重新设计了一个新规格——PPPoE。
    PPPoE: Point-to-Point Protocol over Ethernet, 以太网的点对点协议。

![PPP认证流程.jpg](/images/网络是怎样连接的/4.18-ab.jpg "PPP认证流程")

![PPP认证流程（续）.jpg](/images/网络是怎样连接的/4.18-c.jpg "PPP认证流程（续）")


接入网的整体工作过程

    互联网接入路由器通过 PPPoE 的发现机制查询 BAS 的 MAC 地址。

    BAS 下发的 TCP/IP 参数会被配置到互联网接入路由器的 BAS 端的端口上，这样路由器就完成接入互联网的准备了。

    然后包会转发到 BAS 下发的默认路由的网关地址，按照 PPPoE 的规则转发。MAC 头部中，接收方 MAC 地址填写通过 PPPoE 发现机制查询到的 BAS 的 MAC 地址，发送方 MAC 地址填写互联网接入路由器的 BAS 端的端口的 MAC 地址。然后是 PPPoE 头部和 PPP 头部，再往后的部分就是包含 IP 头部在内的原始网络包。

    BAS 在收到用户路由器发送的网络包之后，会去掉 MAC 头部和 PPPoE 头部，然后用隧道机制将包发送给网络运营商路由器。

不分配 IP 地址的无编号端口

    一对一连接的端口可以不分配 IP 地址，这种方式成为无编号。

除 PPPoE 的其他方式

1. PPPoA 方式不添加 MAC 头部和 PPPoE 头部，而是直接将包装入信元中

    由于 PPPoA 没有 MAC 头部，所以 PPP 消息无法通过以太网来传输，这就意味着需要和 BAS 收发 PPP 消息的设备，也就是计算机和路由器必须和 ADSL Modem 是一体的。

    PPPoA: Point-to-Point Protocol over ATM.

2. DHCP

    DHCP 不使用 PPP，ADSL Modem 也不使用信元，而是将以太网包直接转成 ADSL 信号发送给 DSLAM。

    DHCP: Dynamic Host Configuration Protocol, 动态主机配置协议。


### 4. 网络运营商的内部

POP 和 NOC

    网络包通过接入网之后，到达运营商 POP 的路由器。可以简单的理解为 NOC 就是规模扩大后的 POP。

    POP: Point of Presense, 中文一般叫作“接入点”。
    NOC: Network Operation Certer, 网络运行中心。

![互联网内部概览.jpg](/images/网络是怎样连接的/4.23.jpg "互联网内部概览")

![POP概览.jpg](/images/网络是怎样连接的/4.24.jpg "POP概览")

### 5. 跨越运营商的网络包

运营商之间的路由信息交换

    互联网内部使用 BGP 机制在运营商之间交换路由信息。
    BGP: Border Gateway Protocol, 边界网关协议。

![运营商之间的路由信息交换.jpg](/images/网络是怎样连接的/4.25.jpg "运营商之间的路由信息交换")

![路由信息交换的类型.jpg](/images/网络是怎样连接的/4.26.jpg "路由信息交换的类型")

    IX: Internet eXchange, 中文一般叫做“互联网交换中心”。

![IX的必要性.jpg](/images/网络是怎样连接的/4.27.jpg "IX的必要性")

- - -

## 五、服务器端的局域网

### 1. Web服务器的部署地点

![服务器的所在地.jpg](/images/网络是怎样连接的/5.1.jpg "服务器的所在地")

### 2. 防火墙的结构和原理

包过滤规则

![地址转换和包过滤中用于设置规则的字段.jpg](/images/网络是怎样连接的/b5.1.jpg "地址转换和包过滤中用于设置规则的字段")

包过滤示例

    Web 服务器所在的网络可以从外网直接访问。我们希望允许从互联网访问 Web 服务器，但禁止 Web 服务器访问互联网。
    第一行：允许起点（发送方 IP 地址）为任意，终点（接收方 IP 地址）为 Web 服务器 IP 地址且接收端口为 80 的包通过。
    第二行：阻止 TCP 连接操作的第一个包，方向是 Web 服务器发往互联网的，TCP 连接操作就失败了。这就阻止了 Web 服务器对互联网的访问。
    第三行：在 Web 服务器发往互联网的包中，我们可以将起点（发送方 IP 地址）为 Web 服务器地址且发送方端口为 80 的包设置为允许通过。

![包过滤的典型示例.jpg](/images/网络是怎样连接的/5.2.jpg "包过滤的典型示例")

防火墙无法抵御的攻击

    防火墙无法检查包的内容

### 3. 服务器的负载均衡

采用分布式架构，使用多台服务器来分担负载。必须有一个机制将客户端发送的请求分配到每台服务器上

1. 轮询

    通过 DNS 服务器来分配。如果服务器的 IP 地址在 DNS 服务器中有多个名称相同的记录，则每次查询时 DNS 服务器都会按顺序返回不同的 IP 地址。
    缺点是服务器宕机时并不会跳过，而且如果操作是跨多个页面的，这期间访问的服务器发生变化也会引发问题。

![DNS轮询.jpg](/images/网络是怎样连接的/5.3.jpg "DNS轮询")

2. 负载均衡器

    用负载均衡器的 IP 地址代替 Web 服务器的实际地址注册到 DNS 服务器上，然后由负载均衡器来判断将请求转发给哪台 Web 服务器。（转发请求消息使用的是代理机制）

![用于对多台Web服务器分配访问的负载均衡器.jpg](/images/网络是怎样连接的/5.4.jpg "用于对多台Web服务器分配访问的负载均衡器")

### 4. 缓存服务器

缓存服务器是一台通过代理机制对数据进行缓存的服务器，与负载均衡器一样，需要代替 Web 服务器被注册到 DNS 服务器中。代理介于 Web 服务器和客户端之间，具有对 Web 服务器访问进行中转的功能。

通过更新时间管理内容

![临时保存内容并代替Web服务器返回内容的缓存服务器.jpg](/images/网络是怎样连接的/5.5.jpg "临时保存内容并代替Web服务器返回内容的缓存服务器")

![缓存中没有数据的情况.jpg](/images/网络是怎样连接的/5.6.jpg "缓存中没有数据的情况")

![缓存中有数据的情况.jpg](/images/网络是怎样连接的/5.7.jpg "缓存中有数据的情况")

正向代理

![利用代理实现防火墙.jpg](/images/网络是怎样连接的/5.8.jpg "利用代理实现防火墙")

![正向代理的HTTP消息.jpg](/images/网络是怎样连接的/5.9.jpg "正向代理的HTTP消息")

反向代理

    缓存服务器

透明代理

    根据请求消息包的 IP 头部中的 IP 地址进行转发称为透明代理。
    透明代理集合了正向代理和反向代理的优点。由于透明代理不需要设置在浏览器中，也不能通过 DNS 服务器解析引导，否则透明代理本身就变成了访问目标，也就无法通过接收方 IP 地址判断转发目标了。所以透明代理必须放在浏览器到 Web 服务器的路径中，对消息进行拦截。
    使用透明代理时，用户不会察觉到代理的存在，也不会注意到 HTTP 消息是如何被转发的，因此大家更倾向于将透明代理说成是缓存。

### 5. 内容分发服务

    由 CDSP 与供应商签约，并部署多台缓存服务器。另一方面，CDSP 与 Web 服务器运营者签约，使得 CDSP 的缓存服务器配合 Web 服务器工作

    内容分发服务 CDS（Content Delivery Service）也叫 CDN（Content Delivery Network 或 Content Distribution Network）

    CDSP：Content Delivery Service Provider，内容分发服务运营商。

DNS 服务器工作方式

![DNS服务器的一般工作方式.jpg](/images/网络是怎样连接的/5.12.jpg "DNS服务器的一般工作方式")

用 DNS 服务器分配访问目标

![DNS服务器参照路由信息时的工作方式.jpg](/images/网络是怎样连接的/5.13.jpg "DNS服务器参照路由信息时的工作方式")

通过重定向服务器分配访问目标

![通过重定向让客户端访问最近的缓存服务器的机制.jpg](/images/网络是怎样连接的/5.14.jpg "通过重定向让客户端访问最近的缓存服务器的机制")

- - -

## 六、Web服务器返回响应到浏览器

### 1. 服务器概览

服务器程序结构

![用不同的模块与每个客户端进行通信.jpg](/images/网络是怎样连接的/6.1.jpg "用不同的模块与每个客户端进行通信")

服务器端的套接字和端口号

    新创建的套接字副本必须和原来的等待连接的套接字具有相同的端口号。
    如果一个端口号对应多个套接字，就无法通过端口号来定位到某一个套接字。
    解决方法是用下面 4 种信息来判断

    客户端 IP 地址
    客户端端口号
    服务器端 IP 地址
    服务器端端口号

![服务器程序的通信操作.jpg](/images/网络是怎样连接的/6.2.jpg "服务器程序的通信操作")

![服务器端的套接字.jpg](/images/网络是怎样连接的/6.3.jpg "服务器端的套接字")

![分配接收到的包.jpg](/images/网络是怎样连接的/6.4.jpg "分配接收到的包")

### 2. 服务器的接收操作

服务器的接收操作与客户端一样

![服务器将接收到的电信号还原为数字信息.jpg](/images/网络是怎样连接的/6.5.jpg "服务器将接收到的电信号还原为数字信息")

![根据信号还原的数字信息.jpg](/images/网络是怎样连接的/6.6.jpg "根据信号还原的数字信息")

    网卡驱动会根据 MAC 头部判断协议类型，并将包交给相应的协议栈

协议栈的 IP 模块会检查 IP 头部

1. 判断是不是发给自己的；
2. 判断网络包是否经过分片
3. 将包转交给 TCP 或 UDP 模块

如果收到的是发起连接的包，则 TCP 模块会

1. 确认 TCP 头部的控制位
2. 检查接收方端口号
3. 为相应的等待连接套接字复制一个新的副本
4. 记录发送方 IP 地址和端口号等信息

收到数据包时，TCP 模块会

1. 根据收到的包的发送方 IP 地址、发送方端口号、接收方 IP 地址、接收方端口号找到相对应的套接字
2. 将数据块拼合起来并保存在接收缓冲区中，一般应用程序会在数据到达之前调用 read，在这种情况下，TCP 模块在完成接收操作的同时就会将数据转交给应用程序
3. 向客户端返回 ACK

### 3. Web服务器程序作出响应

虚拟目录

![客户端看到的目录结构和实际目录结构是不同的.jpg](/images/网络是怎样连接的/6.9.jpg "客户端看到的目录结构和实际目录结构是不同的")

运行 CGI 程序

![数据如何传递给Web服务器上运行的程序.jpg](/images/网络是怎样连接的/6.11.jpg "数据如何传递给Web服务器上运行的程序")

Web 服务器的访问控制

1. 客户端的 IP 地址
2. 客户端域名

![根据域名进行访问控制.jpg](/images/网络是怎样连接的/6.12.jpg "根据域名进行访问控制")

3. 用户名和密码

![利用HTTP验证用户名和密码.jpg](/images/网络是怎样连接的/6.13.jpg "利用HTTP验证用户名和密码")

### 4. 浏览器接收响应消息并显示内容

通过响应的数据类型判断其中的内容

![消息的Content-Type定义的数据类型.jpg](/images/网络是怎样连接的/b6.1.jpg "消息的Content-Type定义的数据类型")

浏览器显示网页内容

    浏览器解释标签的含义，按照指定的样式显示文档的内容。实际的显示操作由操作系统来完成，浏览器负责对操作系统发出指令。

- - -

## 网络包的旅程

![网络包的旅程.jpg](/images/网络是怎样连接的/fl.jpg "网络包的旅程")

